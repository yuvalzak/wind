<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bat Galim Beach ‚Äì Wind Forecast</title>

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:Arial,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    padding:20px;
  }
  .container{
    max-width:1400px;margin:auto;background:#fff;
    border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);
    overflow:hidden;
  }
  .header{
    background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%);
    color:#fff;padding:30px;text-align:center;
  }
  .header h1{font-size:2em;margin-bottom:8px}

  .chart-container{padding:20px}
  .day-separator{
    background:#3498db;color:#fff;
    padding:8px;margin-top:15px;
    text-align:center;font-weight:bold;border-radius:6px;
  }

  /* One day block = fixed Y axis + scrollable content */
  .day-block{
    display:flex;
    border:1px solid rgba(0,0,0,.08);
    border-radius:10px;
    margin-top:10px;
    overflow:hidden;
    background:#fff;
  }

  .y-axis{
    width:62px;
    flex:0 0 62px;
    border-right:1px solid rgba(0,0,0,.08);
    background:#fff;
    padding:8px 6px;
  }
  .y-axis .unit{
    font-size:11px;
    font-weight:700;
    color:#2c3e50;
    text-align:center;
    margin-bottom:6px;
  }
  .y-axis .ticks{
    height:220px;            /* must match canvas height */
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    font-size:12px;
    color:#555;
    text-align:right;
    padding-right:4px;
  }

  .day-scroll{
    flex:1 1 auto;
    overflow-x:auto;
    overflow-y:hidden;
    padding:10px 0; /* vertical spacing */
  }
  .day-scroll-inner{ padding:0 10px; }

  .chart-wrapper{margin-bottom:6px}

  .direction-row{
    display:flex;background:#ecf0f1;
    border-radius:8px;padding:10px 0;margin-top:10px;
  }
  .time-row{display:flex;padding:8px 0}

  .direction-item,.time-item{
    text-align:center;flex-shrink:0;padding:5px;
  }
  .arrow{font-size:1.5em}
  .degree{font-size:.75em;color:#666}
  .time-label{font-size:.8em;font-weight:600}

  .legend{
    display:flex;justify-content:center;gap:16px;
    padding:12px;background:#f8f9fa;
    margin:10px 20px;border-radius:8px;
    font-size:.85em;flex-wrap:wrap;
  }
  .legend span{display:flex;align-items:center;gap:6px}
  .box{width:22px;height:12px;border-radius:3px}

  .loading{
    text-align:center;padding:60px 20px;
    font-size:1.2em;color:#666;
  }
  .error{
    text-align:center;padding:40px;
    color:#e74c3c;font-size:1.1em;line-height:1.4;
  }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>üåä Bat Galim Beach Wind Forecast</h1>
    <p>ICON Global ‚Ä¢ +10 kts for E‚ÄìSE winds (80¬∞‚Äì125¬∞)</p>
  </div>

  <div class="legend">
    <span><div class="box" style="background:#3498db"></div>&lt;15</span>
    <span><div class="box" style="background:#f39c12"></div>15‚Äì20</span>
    <span><div class="box" style="background:#e67e22"></div>20‚Äì25</span>
    <span><div class="box" style="background:#d35400"></div>25‚Äì30</span>
    <span><div class="box" style="background:#c0392b"></div>30+</span>
    <span style="margin-left:10px;">Wind = solid ‚Ä¢ Gusts = dashed</span>
  </div>

  <div id="content" class="chart-container">
    <div class="loading">Loading‚Ä¶</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  const LAT = 32.8333, LON = 34.9667;

  // Keep chart instances so refresh doesn't pile them up
  const charts = [];

  // Use a constant item width so "scroll all days together" behaves nicely
  const ITEM_W = 70;          // px per hour cell
  const CANVAS_H = 220;       // must match CSS .y-axis .ticks height

  // Prevent scroll event feedback loops
  let syncingScroll = false;

  // üé® value ‚Üí color
  function speedColor(v){
    if (v < 15) return '#3498db';   // blue
    if (v < 20) return '#f39c12';   // orange
    if (v < 25) return '#e67e22';   // dark orange
    if (v < 30) return '#d35400';   // orange-red
    return '#c0392b';              // red
  }

  async function loadForecast(){
    try{
      const r = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
        `&hourly=windspeed_10m,winddirection_10m,windgusts_10m` +
        `&windspeed_unit=kn&timezone=Asia/Jerusalem&forecast_days=7&models=icon_global`,
        { cache:'no-store' }
      );
      if(!r.ok) throw new Error('API error');
      render(await r.json());
    }catch(e){
      document.getElementById('content').innerHTML =
        `<div class="error">‚ùå Failed to load forecast.<br><br>
         If you opened as <b>file://</b> and your browser blocks requests, run:<br>
         <code>python -m http.server 8000</code><br>
         and open: <code>http://localhost:8000/yourfile.html</code></div>`;
    }
  }

  function render(data){
    // destroy old charts
    charts.forEach(c => { try{ c.destroy(); }catch{} });
    charts.length = 0;

    const h = data.hourly;

    let html = '';
    let curDay = '';
    let day = [];

    window.days = {};

    for(let i=0;i<h.time.length;i++){
      const t = new Date(h.time[i]);
      const dLabel = t.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });

      if(dLabel !== curDay){
        if(day.length) html += dayBlock(curDay, day);
        curDay = dLabel;
        day = [];
      }

      const dir = Number(h.winddirection_10m[i]);
      const bonus = (dir >= 80 && dir <= 125) ? 10 : 0;

      day.push({
        time: t,
        speed: Math.round(Number(h.windspeed_10m[i]) + bonus),
        gust:  Math.round(Number(h.windgusts_10m[i]) + bonus),
        dir
      });
    }
    if(day.length) html += dayBlock(curDay, day);

    document.getElementById('content').innerHTML = html;

    // draw
    Object.values(window.days).forEach(drawDay);

    // setup synchronized scrolling across all days
    wireScrollSync();

    // on open: scroll to 09:00 (use the first day that has 09:00)
    scrollAllToNineAM();
  }

  function idSafe(s){ return s.replace(/[^a-z0-9]/gi,'_'); }

  function dayBlock(label, data){
    const id = idSafe(label);
    window.days[id] = { label, data };

    return `
      <div class="day-separator">${label}</div>
      <div class="day-block">
        <div class="y-axis" id="y_${id}">
          <div class="unit">kts</div>
          <div class="ticks" id="ticks_${id}"></div>
        </div>
        <div class="day-scroll" id="scroll_${id}">
          <div class="day-scroll-inner" id="inner_${id}">
            <div class="chart-wrapper"><canvas id="c_${id}"></canvas></div>
            <div class="direction-row" id="d_${id}"></div>
            <div class="time-row" id="t_${id}"></div>
          </div>
        </div>
      </div>
    `;
  }

  function drawDay({ label, data }){
    const id = idSafe(label);

    const inner = document.getElementById(`inner_${id}`);
    const dRow  = document.getElementById(`d_${id}`);
    const tRow  = document.getElementById(`t_${id}`);

    // Make the scrollable content wide enough for all hours
    const totalW = (ITEM_W * data.length) + 20;
    inner.style.width = totalW + 'px';

    // Fill direction + time (aligned by ITEM_W)
    for(const o of data){
      dRow.insertAdjacentHTML('beforeend', `
        <div class="direction-item" style="width:${ITEM_W}px">
          <div class="arrow" style="transform:rotate(${o.dir}deg)">‚Üì</div>
          <div class="degree">${Math.round(o.dir)}¬∞</div>
        </div>
      `);

      tRow.insertAdjacentHTML('beforeend', `
        <div class="time-item" style="width:${ITEM_W}px">
          <div class="time-label">${o.time.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false})}</div>
        </div>
      `);
    }

    // Compute yMax for tick labels
    const maxV = Math.max(...data.map(o => Math.max(o.speed, o.gust)));
    const yMax = Math.max(35, Math.ceil(maxV / 5) * 5);

    // Build fixed y-axis tick labels (visible while scrolling)
    buildYAxisTicks(id, yMax);

    // Canvas sizing (chart scrolls with the content; y-axis stays fixed)
    const c = document.getElementById(`c_${id}`);
    c.width  = totalW;
    c.height = CANVAS_H;

    // Chart: color segments by value (both datasets)
    charts.push(new Chart(c, {
      type: 'line',
      data: {
        labels: data.map(o => o.time),
        datasets: [
          {
            label: 'Wind',
            data: data.map(o => o.speed),
            borderWidth: 3,
            tension: 0.35,
            pointRadius: 4,
            segment: { borderColor: ctx => speedColor(ctx.p0.parsed.y) },
            pointBackgroundColor: ctx => speedColor(ctx.parsed.y)
          },
          {
            label: 'Gusts',
            data: data.map(o => o.gust),
            borderDash: [6,4],
            borderWidth: 3,
            tension: 0.35,
            pointRadius: 4,
            segment: { borderColor: ctx => speedColor(ctx.p0.parsed.y) },
            pointBackgroundColor: ctx => speedColor(ctx.parsed.y)
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} kts`
            }
          }
        },
        interaction: { mode:'index', intersect:false },
        scales: {
          y: {
            beginAtZero: true,
            max: yMax,
            ticks: { stepSize: 5 },
            title: { display: false },
            grid: { color:'rgba(0,0,0,0.08)' }
          },
          x: { display:false }
        }
      }
    }));
  }

  function buildYAxisTicks(id, yMax){
    const ticksEl = document.getElementById(`ticks_${id}`);
    if(!ticksEl) return;

    // Show labels from yMax down to 0 (step 5)
    const step = 5;
    const values = [];
    for(let v=yMax; v>=0; v-=step) values.push(v);

    ticksEl.innerHTML = values.map(v => `<div>${v}</div>`).join('');
  }

  function wireScrollSync(){
    const scrollers = Array.from(document.querySelectorAll('.day-scroll'));

    scrollers.forEach(sc => {
      sc.addEventListener('scroll', () => {
        if(syncingScroll) return;
        syncingScroll = true;
        const x = sc.scrollLeft;
        for(const other of scrollers){
          if(other !== sc) other.scrollLeft = x;
        }
        syncingScroll = false;
      }, { passive:true });
    });
  }

  function scrollAllToNineAM(){
    const scrollers = Array.from(document.querySelectorAll('.day-scroll'));
    if(scrollers.length === 0) return;

    // Find a day that actually contains 09:00, then compute scrollLeft from its index.
    // If not found, fallback to 0.
    let targetX = 0;

    const dayEntries = Object.values(window.days || {});
    for(const day of dayEntries){
      const idx = day.data.findIndex(o => o.time.getHours() === 9);
      if(idx >= 0){
        // Center 09:00 a bit from the left edge
        targetX = Math.max(0, (idx * ITEM_W) - (ITEM_W * 1));
        break;
      }
    }

    syncingScroll = true;
    for(const sc of scrollers) sc.scrollLeft = targetX;
    syncingScroll = false;
  }

  loadForecast();
  setInterval(loadForecast, 30 * 60 * 1000);
</script>
</body>
</html>
