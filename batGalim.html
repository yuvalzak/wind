<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bat Galim Beach - Wind Forecast Chart</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 { font-size: 2em; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 1.1em; }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 1.2em;
      color: #666;
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #e74c3c;
      font-size: 1.1em;
    }

    .chart-container { padding: 20px; }

    .day-separator {
      background: #3498db;
      color: white;
      padding: 8px;
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
      border-radius: 5px;
    }

    .color-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 10px 20px;
      flex-wrap: wrap;
      font-size: 0.85em;
    }
    .legend-item { display:flex; align-items:center; gap:8px; }
    .legend-color-box { width: 30px; height: 15px; border-radius: 3px; }

    /* ‚úÖ ONE shared scroller per day */
    .day-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      border-radius: 10px;
      background: #fff;
      margin-top: 10px;
      padding: 10px 0;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .day-scroll-inner {
      /* this width is set in JS */
      padding: 0 10px;
    }

    .direction-row {
      display: flex;
      background: #ecf0f1;
      border-radius: 8px;
      padding: 10px 0;
      margin-top: 10px;
    }

    .time-row {
      display: flex;
      padding: 10px 0;
      margin-top: 5px;
    }

    .direction-item, .time-item {
      text-align: center;
      padding: 5px;
      flex-shrink: 0;
    }

    .arrow { font-size: 1.5em; display: inline-block; }
    .degree { font-size: 0.75em; color: #666; margin-top: 2px; }
    .time-label { font-size: 0.8em; color: #2c3e50; font-weight: 600; }

    .chart-wrapper {
      padding: 0 0 5px 0;
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåä Bat Galim Beach Wind Forecast</h1>
      <p>Haifa, Israel ‚Ä¢ 32.8333¬∞N, 34.9667¬∞E</p>
      <p style="font-size: 0.9em; margin-top: 5px; opacity: 0.8;">Model: DWD ICON Global</p>
      <p style="font-size: 0.85em; margin-top: 8px; opacity: 0.9;">‚ö° +10 knots added for E-SE winds (80¬∞-125¬∞) - local acceleration effect</p>
    </div>

    <div class="color-legend">
      <div class="legend-item"><div class="legend-color-box" style="background:#3498db;"></div><span>&lt;15 kts</span></div>
      <div class="legend-item"><div class="legend-color-box" style="background:#f39c12;"></div><span>15-20 kts</span></div>
      <div class="legend-item"><div class="legend-color-box" style="background:#e67e22;"></div><span>20-25 kts</span></div>
      <div class="legend-item"><div class="legend-color-box" style="background:#d35400;"></div><span>25-30 kts</span></div>
      <div class="legend-item"><div class="legend-color-box" style="background:#c0392b;"></div><span>30+ kts</span></div>
    </div>

    <div id="content">
      <div class="loading">Loading forecast data...</div>
    </div>
  </div>

  <!-- Pinning version helps stability -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const LAT = 32.8333;
    const LON = 34.9667;

    // Keep chart instances so refresh doesn't pile them up
    const charts = [];

    async function getForecast() {
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=windspeed_10m,winddirection_10m,windgusts_10m&windspeed_unit=kn&timezone=Asia/Jerusalem&forecast_days=7&models=icon_global`,
          { cache: "no-store" }
        );

        if (!response.ok) throw new Error('Failed to fetch forecast data');
        const data = await response.json();
        displayForecast(data);
      } catch (error) {
        document.getElementById('content').innerHTML =
          `<div class="error">‚ùå Error loading forecast: ${error.message}<br><br>Please check your internet connection.</div>`;
      }
    }

    function displayForecast(data) {
      // destroy old charts
      while (charts.length) charts.pop().destroy?.();

      const hourly = data.hourly;
      let html = '<div class="chart-container">';

      let currentDay = '';
      let dayData = [];

      for (let i = 0; i < hourly.time.length; i++) {
        const datetime = new Date(hourly.time[i]);
        const dayStr = datetime.toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric'
        });

        if (dayStr !== currentDay) {
          if (dayData.length > 0) html += createDayBlock(currentDay, dayData);
          currentDay = dayStr;
          dayData = [];
        }

        const direction = Number(hourly.winddirection_10m[i]);
        const rawSpeed = Number(hourly.windspeed_10m[i]);
        const rawGusts = Number(hourly.windgusts_10m[i]);

        const isEastWind = direction >= 80 && direction <= 125;
        const speedBonus = isEastWind ? 10 : 0;

        dayData.push({
          time: datetime,
          speed: Math.round(rawSpeed + speedBonus),
          gusts: Math.round(rawGusts + speedBonus),
          direction,
          isEastWind
        });
      }

      if (dayData.length > 0) html += createDayBlock(currentDay, dayData);

      html += '</div>';
      document.getElementById('content').innerHTML = html;

      createAllDays();
    }

    function safeId(dayStr) {
      return dayStr.replace(/[^a-zA-Z0-9]/g, '_');
    }

    function createDayBlock(dayStr, dayData) {
      const id = safeId(dayStr);
      const chartId = `chart_${id}`;
      const dirId = `dir_${id}`;
      const timeId = `time_${id}`;
      const scrollInnerId = `inner_${id}`;

      if (!window.chartData) window.chartData = {};
      window.chartData[id] = { dayStr, dayData, chartId, dirId, timeId, scrollInnerId };

      return `
        <div class="day-separator">${dayStr}</div>

        <!-- ‚úÖ ONE SCROLLER THAT CONTAINS CHART + DIRECTIONS + TIME -->
        <div class="day-scroll">
          <div class="day-scroll-inner" id="${scrollInnerId}">
            <div class="chart-wrapper">
              <canvas id="${chartId}"></canvas>
            </div>
            <div class="direction-row" id="${dirId}"></div>
            <div class="time-row" id="${timeId}"></div>
          </div>
        </div>
      `;
    }

    function createAllDays() {
      if (!window.chartData) return;

      for (const key of Object.keys(window.chartData)) {
        const info = window.chartData[key];
        renderDay(info);
      }
    }

    function renderDay({ dayData, chartId, dirId, timeId, scrollInnerId }) {
      const inner = document.getElementById(scrollInnerId);
      const dirContainer = document.getElementById(dirId);
      const timeContainer = document.getElementById(timeId);

      // Width per item (keep alignment consistent)
      const itemWidth = Math.max(50, Math.floor(900 / Math.max(1, dayData.length)));
      const totalWidth = (itemWidth * dayData.length) + 20; // + padding space

      // ‚úÖ Set inner width so the whole day block scrolls as one
      inner.style.width = totalWidth + "px";

      // Fill direction + time
      dayData.forEach((item) => {
        const timeStr = item.time.toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit', hour12: false
        });

        const arrowDiv = document.createElement('div');
        arrowDiv.className = 'direction-item';
        arrowDiv.style.width = itemWidth + 'px';
        arrowDiv.style.background = item.isEastWind ? '#ffe6e6' : 'transparent';
        arrowDiv.innerHTML = `
          <div class="arrow" style="transform: rotate(${item.direction}deg); color: ${item.isEastWind ? '#e74c3c' : '#333'};">‚Üì</div>
          <div class="degree">${Math.round(item.direction)}¬∞</div>
          ${item.isEastWind ? '<div style="font-size:0.7em;color:#e74c3c;font-weight:bold;">+10kts</div>' : ''}
        `;
        dirContainer.appendChild(arrowDiv);

        const timeDiv = document.createElement('div');
        timeDiv.className = 'time-item';
        timeDiv.style.width = itemWidth + 'px';
        timeDiv.innerHTML = `<div class="time-label">${timeStr}</div>`;
        timeContainer.appendChild(timeDiv);
      });

      // Chart setup
      const canvas = document.getElementById(chartId);
      if (!canvas) return;

      // ‚úÖ Make canvas match the scroll width, so chart aligns with items
      canvas.width = totalWidth;
      canvas.height = 220; // fixed height

      const labels = dayData.map(d => d.time.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: false
      }));

      const windColors = dayData.map(d => {
        if (d.speed < 15) return '#3498db';
        if (d.speed < 20) return '#f39c12';
        if (d.speed < 25) return '#e67e22';
        if (d.speed < 30) return '#d35400';
        return '#c0392b';
      });

      const gustColors = dayData.map(d => {
        if (d.gusts < 15) return '#95a5a6';
        if (d.gusts < 20) return '#f39c12';
        if (d.gusts < 25) return '#e67e22';
        if (d.gusts < 30) return '#d35400';
        return '#c0392b';
      });

      const maxSpeed = Math.max(...dayData.map(d => Math.max(d.speed, d.gusts)));
      const yMax = Math.max(35, Math.ceil(maxSpeed / 5) * 5);

      const ch = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Wind Speed',
              data: dayData.map(d => d.speed),
              segment: { borderColor: ctx => windColors[ctx.p0DataIndex] },
              borderColor: '#000',
              backgroundColor: 'rgba(52,152,219,0.08)',
              borderWidth: 3,
              fill: true,
              tension: 0.35,
              pointRadius: 4,
              pointHoverRadius: 7,
              pointBackgroundColor: windColors,
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            },
            {
              label: 'Wind Gusts',
              data: dayData.map(d => d.gusts),
              segment: { borderColor: ctx => gustColors[ctx.p0DataIndex] },
              borderColor: '#000',
              backgroundColor: 'rgba(231,76,60,0.05)',
              borderWidth: 3,
              fill: false,
              tension: 0.35,
              borderDash: [8, 4],
              pointRadius: 4,
              pointHoverRadius: 7,
              pointBackgroundColor: gustColors,
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }
          ]
        },
        options: {
          // ‚úÖ IMPORTANT: since we manually set canvas width, disable responsive
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { font: { size: 13, weight: 'bold' }, usePointStyle: true, padding: 15 }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} kts`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: yMax,
              title: { display: true, text: 'Wind Speed (knots)', font: { size: 13, weight: 'bold' } },
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            x: { display: false, grid: { display: false } }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });

      charts.push(ch);
    }

    getForecast();
    setInterval(getForecast, 30 * 60 * 1000);
  </script>
</body>
</html>
